---
title: VPS Note
subtitle: 记录家庭服务器和云服务器的服务笔记，用于迁移或者恢复
author: Alomerry Wu
date: 2022-02-26
update: 2022-07-02
---

<!-- Description. -->

<!-- more -->

国内云服务器价格高，家用机器性能过剩，除了用来娱乐，发挥不出作用，通过 frp 内网穿透可以利用家用机器的性能，服务器仅用于部署静态页面。

原本是在 windows 上使用 vmware 安装 ubuntu 已达到兼顾娱乐。但是一来虚拟机有损耗（似乎损耗不大，待查证），其次我发现 steam 的 proton 似乎完善到可用的地步（steamDeck），试了一下，带 EAC 的 Dead by daylight 是不能玩，但是 GTAVol 居然是可玩的，不过会偶尔掉帧，其它一些小型游戏很丝滑。于是格式化了 windows，换成了 ubuntu desktop 20.04。后来有一次无意之间不知道删除了什么，系统崩溃了，后来发现并没有足够时间去娱乐了，就决定直接安装 ubuntu server，痛苦的是我在迁移旧系统的数据文件时遗漏了一部分，我意识到数据在单机存储不做被备份是不靠谱的，于是决定记录下来，并时常备份数据文件。

## List

- 设置 root 密码 `sudo passwd`
- 安装 zsh `sudo apt-get install zsh`
- 安装 oh-my-zsh 以及 zsh-autosuggestions、zsh-syntax-highlighting 插件
  - `REMOTE=https://gitee.com/mirrors/oh-my-zsh.git sh -c "$(curl -fsSL https://gitee.com/mirrors/oh-my-zsh/raw/master/tools/install.sh)"`
  - `git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions`
  - `git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting`
- 禁用睡眠 `sudo systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target`
- 安装 docker
  - `sudo apt-get remove docker docker-engine docker.io containerd runc`
  - `sudo apt-get install ca-certificates curl gnupg lsb-release`
  - `curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg`
  - `echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null`
  - `sudo apt-get update`
  - `sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin`
  - 设置[阿里云镜像加速](https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors)
    - `sudo vim /etc/docker/daemon.json`
    - 添加以下代码：

    ```json:no-line-numbers
    {
      "registry-mirrors": ["https://xxxx.mirror.aliyuncs.com"]
    } 
    ```

    - `sudo systemctl daemon-reload`
    - `sudo systemctl restart docker`
  - 添加当前账号到 sudoer 避免 docker 操作需要 sudo
    - `sudo groupadd docker` 创建组
    - `sudo gpasswd -a ${USER} docker` 将用户添加到该组，例如 xxx 用户
    - `sudo systemctl restart docker` 重启 docker-daemon
  - 登录阿里云容器仓库
    - `docker login --username=9404*****@qq.com registry.cn-hangzhou.aliyuncs.com`
  - 拉取镜像预热
    -  `docker pull registry.cn-hangzhou.aliyuncs.com/alomerry/vscode-web:latest`
    -  `docker pull ghcr.io/umami-software/umami:postgresql-latest`
    -  `docker pull postgres:12-alpine`
    -  `docker pull mondedie/flarum:stable`
    -  `docker pull mariadb:10.5`
    -  `docker pull jenkinsci/blueocean:1.25.5`
    -  `docker pull amir20/dozzle:latest`
- 安装 duf `wget http://cdn.alomerry.com/packages/duf/duf_0.8.1_linux_amd64.deb`
- 安装 htop `sudo apt-get install htop`
- 安装 xfce/xrdp
  - `sudo apt-get install xfce4`
  - `sudo apt-get install xrdp`
  - `sudo echo xfce4-session >~/.xsession`
  - `sudo service xrdp restart`
- 安装软件
  - smplayer `sudo apt-get install smplayer`
  - 安装 edge `wget http://cdn.alomerry.com/packages/applications/microsoft-edge-stable_104.0.1293.47-1_amd64.deb`
    - 安装 switchyomega，设置规则列表网址 https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt
  - 安装 xnview `wget http://cdn.alomerry.com/packages/applications/XnViewMP-linux-x64.deb`
- 安装 frp
  - `wget http://cdn.alomerry.com/packages/frp/frp_0.43.0_linux_amd64.tar.gz`
  - `tar -xf frp_0.43.0_linux_amd64.tar.gz`
  - [设置自启](/posts/2022-06-17-frp.md)
  - 配置 frpc.ini
- 安装 aliyun-webdav
  - `sudo snap install aliyundrive-webdav`

## docker

### umami

@[code yml:no-line-numbers](./codes/vps-home/frpc/umami/docker-compose.yml)
### flarum

- 先启动 mariadb `docker compose up -d mariadb`
- `docker compose up -d flarum`
- 安装中文包 `docker exec -ti flarum extension require flarum-lang/chinese-simplified`

@[code yml:no-line-numbers](./codes/vps-home/frpc/flarum/docker-compose.yml)

### vscode web

@[code yml:no-line-numbers](./codes/vps-home/frpc/vscode-web/docker-compose.yml)

### jenkins

@[code yml:no-line-numbers](./codes/vps-home/frpc/jenkins/docker-compose.yml)

### dozzle

@[code yml:no-line-numbers](./codes/vps-home/frpc/dozzle/docker-compose.yml)

## TODO

- 工具 GoAccess `tail -F /www/wwwlog/xxx.com.log | docker run -p 7890:7890 --rm -i -e LANG=zh_CN -e TZ="Asia/Shanghai" allinurl/goaccess -a -o html --log-format COMBINED --real-time-html - > report.html`